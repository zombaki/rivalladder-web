<div class="ladder-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Club Ladder Rankings</mat-card-title>
      <mat-card-subtitle>Challenge players to climb the ladder</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      @if (isLoading$ | async) {
        <div class="loading-container">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Loading ladder...</p>
        </div>
      } @else {
        <div class="table-container">
          <table mat-table [dataSource]="(players$ | async) || []" class="ladder-table">
            <!-- Rank Column -->
            <ng-container matColumnDef="rank">
              <th mat-header-cell *matHeaderCellDef>Rank</th>
              <td mat-cell *matCellDef="let player">
                <span class="rank-badge" [class.top-rank]="player.currentRank <= 3">
                  #{{ player.currentRank }}
                </span>
              </td>
            </ng-container>

            <!-- Rank Change Column -->
            <ng-container matColumnDef="rankChange">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let player">
                @if (getRankChange(player) !== 0) {
                  <mat-icon 
                    [class]="'rank-change-icon ' + getRankChangeColor(getRankChange(player))"
                    [attr.aria-label]="'Rank change: ' + getRankChange(player)">
                    {{ getRankChangeIcon(getRankChange(player)) }}
                  </mat-icon>
                }
              </td>
            </ng-container>

            <!-- Player Column -->
            <ng-container matColumnDef="player">
              <th mat-header-cell *matHeaderCellDef>Player</th>
              <td mat-cell *matCellDef="let player">
                <div class="player-info">
                  @if (player.avatar) {
                    <img [src]="player.avatar" [alt]="player.firstName + ' ' + player.lastName" class="player-avatar">
                  } @else {
                    <mat-icon class="player-avatar-icon">account_circle</mat-icon>
                  }
                  <div class="player-details">
                    <span class="player-name">{{ player.firstName }} {{ player.lastName }}</span>
                    @if ((currentUserId$ | async) === player.userId) {
                      <mat-chip class="you-chip">You</mat-chip>
                    }
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Record Column -->
            <ng-container matColumnDef="record">
              <th mat-header-cell *matHeaderCellDef>Record</th>
              <td mat-cell *matCellDef="let player">
                <span class="record">{{ player.wins }}W - {{ player.losses }}L</span>
              </td>
            </ng-container>

            <!-- Streak Column -->
            <ng-container matColumnDef="streak">
              <th mat-header-cell *matHeaderCellDef>Streak</th>
              <td mat-cell *matCellDef="let player">
                @if (player.winStreak > 0) {
                  <mat-chip class="streak-chip win-streak">
                    <mat-icon>local_fire_department</mat-icon>
                    {{ player.winStreak }}
                  </mat-chip>
                }
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let player">
                @if (currentUserId$ | async; as userId) {
                  @if (canChallenge(player, userId)) {
                    <button 
                      mat-raised-button 
                      color="primary" 
                      (click)="challengePlayer(player)"
                      aria-label="Challenge player">
                      Challenge
                    </button>
                  }
                }
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
                [class.current-user-row]="(currentUserId$ | async) === row.userId"></tr>
          </table>
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>
